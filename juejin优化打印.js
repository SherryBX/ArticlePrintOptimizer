// ==UserScript==
// @name         Á®ÄÂúüÊéòÈáëÊñáÁ´†‰ºòÂåñÊâìÂç∞
// @namespace    http://tampermonkey.net/
// @version      1.0
// @description  ‰ºòÂåñÁ®ÄÂúüÊéòÈáëÊñáÁ´†È°µÈù¢Áî®‰∫éÊâìÂç∞ÔºåÁßªÈô§‰∏çÂøÖË¶ÅÂÖÉÁ¥†Âπ∂Ëá™Âä®Ë∞ÉÁî®ÊâìÂç∞ÂäüËÉΩÔºåÊîØÊåÅÂØºÂá∫PDF
// @author       Sherry
// @match        *://juejin.cn/post/*
// @grant        none
// @run-at       document-end
// @icon         https://lf3-cdn-tos.bytescdn.com/obj/static/xitu_juejin_web/static/favicons/favicon-32x32.png
// @license      MIT
// ==/UserScript==

(function(){
    'use strict';
    
    // ÂàõÂª∫ÊéßÂà∂Èù¢Êùø
    function createControlPanel() {
        const panel = document.createElement('div');
        panel.id = 'juejin-print-panel';
        panel.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 9999;
            font-family: Arial, sans-serif;
            font-size: 14px;
            cursor: move;
            width: 150px;
            box-sizing: content-box;
        `;
        
        const title = document.createElement('div');
        title.textContent = 'üìÑ ÊéòÈáëÊâìÂç∞‰ºòÂåñ';
        title.style.cssText = `
            font-weight: bold;
            margin-bottom: 10px;
            text-align: center;
            color: #333;
            cursor: move;
        `;
        
        const optimizeBtn = document.createElement('button');
        optimizeBtn.textContent = 'üñ®Ô∏è ‰ºòÂåñÂπ∂ÊâìÂç∞';
        optimizeBtn.style.cssText = `
            background-color: #1e80ff;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 5px 10px;
            margin: 5px;
            cursor: pointer;
            width: calc(100% - 10px);
            box-sizing: border-box;
        `;
        optimizeBtn.onclick = function() {
            optimizePage(true);
        };
        
        const savePdfBtn = document.createElement('button');
        savePdfBtn.textContent = 'üíæ ‰øùÂ≠ò‰∏∫PDF';
        savePdfBtn.style.cssText = `
            background-color: #007acc;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 5px 10px;
            margin: 5px;
            cursor: pointer;
            width: calc(100% - 10px);
            box-sizing: border-box;
        `;
        savePdfBtn.onclick = function() {
            optimizePage(false, true);
        };
        
        const optimizeOnlyBtn = document.createElement('button');
        optimizeOnlyBtn.textContent = '‚ú® ‰ªÖ‰ºòÂåñÈ°µÈù¢';
        optimizeOnlyBtn.style.cssText = `
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 5px 10px;
            margin: 5px;
            cursor: pointer;
            width: calc(100% - 10px);
            box-sizing: border-box;
        `;
        optimizeOnlyBtn.onclick = function() {
            optimizePage(false, false);
        };
        
        const resetBtn = document.createElement('button');
        resetBtn.textContent = 'üîÑ ÊÅ¢Â§çÂéüÈ°µÈù¢';
        resetBtn.style.cssText = `
            background-color: #f44336;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 5px 10px;
            margin: 5px;
            cursor: pointer;
            width: calc(100% - 10px);
            box-sizing: border-box;
        `;
        resetBtn.onclick = function() {
            location.reload();
        };
        
        panel.appendChild(title);
        panel.appendChild(optimizeBtn);
        panel.appendChild(savePdfBtn);
        panel.appendChild(optimizeOnlyBtn);
        panel.appendChild(resetBtn);
        
        document.body.appendChild(panel);
        
        // Ê∑ªÂä†ÊãñÊãΩÂäüËÉΩ
        makeDraggable(panel);
    }
    
    // ‰ΩøÂÖÉÁ¥†ÂèØÊãñÊãΩ
    function makeDraggable(element) {
        let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
        
        element.onmousedown = dragMouseDown;
        
        function dragMouseDown(e) {
            e = e || window.event;
            e.preventDefault();
            // Ëé∑ÂèñÈº†Ê†á‰ΩçÁΩÆ
            pos3 = e.clientX;
            pos4 = e.clientY;
            document.onmouseup = closeDragElement;
            // Èº†Ê†áÁßªÂä®Êó∂Ë∞ÉÁî®elementDrag
            document.onmousemove = elementDrag;
        }
        
        function elementDrag(e) {
            e = e || window.event;
            e.preventDefault();
            
            // ‰∏çÂ∫îÁî®‰ªª‰ΩïÁº©ÊîæË∞ÉÊï¥ÔºåÁõ¥Êé•‰ΩøÁî®ÂéüÂßãËÆ°ÁÆó
            pos1 = pos3 - e.clientX;
            pos2 = pos4 - e.clientY;
            pos3 = e.clientX;
            pos4 = e.clientY;
            
            // ËÆæÁΩÆÂÖÉÁ¥†ÁöÑÊñ∞‰ΩçÁΩÆ
            element.style.top = (element.offsetTop - pos2) + "px";
            element.style.left = (element.offsetLeft - pos1) + "px";
            element.style.right = "auto";
        }
        
        function closeDragElement() {
            // ÂÅúÊ≠¢ÁßªÂä®
            document.onmouseup = null;
            document.onmousemove = null;
        }
    }
    
    // ‰ºòÂåñÈ°µÈù¢ÂáΩÊï∞
    function optimizePage(autoPrint = false, savePdf = false) {
        // ‰øùÂ≠òÂéüÂßãÊ†áÈ¢òÁî®‰∫éPDFÊñá‰ª∂Âêç
        const articleTitle = document.querySelector('.article-title')?.textContent || document.title;
        
        // ÁßªÈô§‰∏çÂøÖË¶ÅÂÖÉÁ¥†
        const elementsToRemove = [
            '.article-suspended-panel', // ÊÇ¨ÊµÆÈù¢Êùø
            '.main-header-box', // È°∂ÈÉ®ÂØºËà™
            '.article-title-box + div', // ‰ΩúËÄÖ‰ø°ÊÅØÂå∫Âüü
            '.article-end', // ÊñáÁ´†ÁªìÂ∞æÂå∫Âüü
            '.article-catalog', // ÁõÆÂΩï
            '.article-banner', // ÂπøÂëäÊ®™ÂπÖ
            '.recommended-area', // Êé®ËçêÂå∫Âüü
            '.comment-box', // ËØÑËÆ∫Âå∫
            '.sidebar', // ‰æßËæπÊ†è
            '.extension', // Êâ©Â±ïÂå∫Âüü
            '.column-container', // ‰∏ìÊ†èÂÆπÂô®
            '.footer-wrapper', // È°µËÑö
            '.main-header', // ‰∏ªÈ°µÂ§¥ÈÉ®
            '.article-suspended-panel', // ÊñáÁ´†ÊÇ¨ÊµÆÈù¢Êùø
            '.tag-list-box', // Ê†áÁ≠æÂàóË°®
            '.category-course-recommend', // ËØæÁ®ãÊé®Ëçê
            '.next-article', // ‰∏ã‰∏ÄÁØáÊñáÁ´†
            '.extension-banner', // Êâ©Â±ïÊ®™ÂπÖ
            '.author-info-block', // ‰ΩúËÄÖ‰ø°ÊÅØ
            '.recommend-box', // Êé®ËçêÊ°Ü
            '.article-title-box + div', // ‰ΩúËÄÖ‰ø°ÊÅØ‰∏ãÊñπÁöÑÂàÜ‰∫´Á≠âÊåâÈíÆ
            '.article-title-box .stat-item', // ÊñáÁ´†Ê†áÈ¢ò‰∏ãÁöÑÁªüËÆ°‰ø°ÊÅØ
            '.article-title-box .stat-view-times', // ÈòÖËØªÊ¨°Êï∞
            '.article-title-box .stat-like', // ÁÇπËµû
            '.article-title-box .stat-comment', // ËØÑËÆ∫Êï∞
            '.article-title-box .follow-btn', // ÂÖ≥Ê≥®ÊåâÈíÆ
            '.article-title-box .follow-btn-wrap', // ÂÖ≥Ê≥®ÊåâÈíÆÂåÖË£Ö
            '.column-entry-list', // ‰∏ìÊ†èÂàóË°®
            '.column-entry', // ‰∏ìÊ†èÊù°ÁõÆ
            '.suspension-panel', // ÊÇ¨ÊµÆÈù¢Êùø
            '.suspension-panel.suspension-panel', // ÈáçÂ§çÈÄâÊã©Âô®Á°Æ‰øùÁßªÈô§
            '.article-feedback-wrap', // ÊñáÁ´†ÂèçÈ¶àÂå∫Âüü
            '.article-feedback', // ÊñáÁ´†ÂèçÈ¶à
            '.author-block', // ‰ΩúËÄÖÂùó
            '.wechat-banner', // ÂæÆ‰ø°Ê®™ÂπÖ
            '.category-course-recommend', // ËØæÁ®ãÊé®Ëçê
            '.category-course-box', // ËØæÁ®ãÁõíÂ≠ê
            '.post-recommend-box', // ÊñáÁ´†Êé®ËçêÁõíÂ≠ê
            '.post-list-box', // ÊñáÁ´†ÂàóË°®ÁõíÂ≠ê
            '.app-open-button', // APPÊâìÂºÄÊåâÈíÆ
            '.open-button', // ÊâìÂºÄÊåâÈíÆ
            '.app-download-sidebar-block', // APP‰∏ãËΩΩ‰æßËæπÊ†è
            '.sticky-block', // Á≤òÊÄßÂùó
            '.sticky-block-box', // Á≤òÊÄßÂùóÁõíÂ≠ê
            '.login-guide-box', // ÁôªÂΩïÂºïÂØºÁõíÂ≠ê
            '.login-button-wrap', // ÁôªÂΩïÊåâÈíÆÂåÖË£Ö
            '.login-banner', // ÁôªÂΩïÊ®™ÂπÖ
            '.article-area > div:last-child', // ÊñáÁ´†Âå∫ÂüüÊúÄÂêé‰∏Ä‰∏™divÔºàÈÄöÂ∏∏ÊòØÊé®ËçêÊàñËØÑËÆ∫Ôºâ
            '.article-area > div[data-growing-title]', // Â∏¶Êúâgrowing-titleÂ±ûÊÄßÁöÑdivÔºàÈÄöÂ∏∏ÊòØÂπøÂëäÔºâ
            '.advert-box' // ÂπøÂëäÁõíÂ≠ê
        ];
        
        elementsToRemove.forEach(selector => {
            document.querySelectorAll(selector).forEach(el => {
                el.remove();
            });
        });
        
        // ‰øÆÂ§çÂ∏ÉÂ±Ä
        const articleArea = document.querySelector('.article-area');
        if (articleArea) {
            articleArea.style.cssText = `
                width: 100% !important;
                max-width: 100% !important;
                padding: 20px !important;
                margin: 0 auto !important;
                float: none !important;
                box-sizing: border-box !important;
            `;
        }
        
        const mainContainer = document.querySelector('.main-container');
        if (mainContainer) {
            mainContainer.style.cssText = `
                width: 100% !important;
                max-width: 100% !important;
                padding: 0 !important;
                margin: 0 auto !important;
            `;
        }
        
        const articleContent = document.querySelector('.article-content');
        if (articleContent) {
            articleContent.style.cssText = `
                width: 100% !important;
                max-width: 100% !important;
                padding: 0 !important;
                margin: 0 auto !important;
            `;
        }
        
        // Êâ©Â±ï‰ª£Á†ÅÂùóÂÆΩÂ∫¶
        document.querySelectorAll('pre, code').forEach(el => {
            el.style.maxWidth = '100%';
            el.style.overflow = 'visible';
            el.style.whiteSpace = 'pre-wrap';
        });
        
        // ‰ºòÂåñÂõæÁâáÊòæÁ§∫
        document.querySelectorAll('.article-content img').forEach(img => {
            img.style.maxWidth = '100%';
            img.style.height = 'auto';
            img.style.margin = '10px auto';
            img.style.display = 'block';
            
            // Á°Æ‰øùÂõæÁâáÂú®ÊâìÂç∞Êó∂ÂèØËßÅ
            img.setAttribute('loading', 'eager');
            
            // Ê∑ªÂä†ÂõæÁâáÊèèËø∞‰Ωú‰∏∫Ê†áÈ¢ò
            const altText = img.getAttribute('alt');
            if (altText && !img.nextElementSibling?.classList.contains('img-caption')) {
                const caption = document.createElement('div');
                caption.className = 'img-caption';
                caption.textContent = altText;
                caption.style.cssText = `
                    text-align: center;
                    color: #666;
                    font-size: 0.9em;
                    margin-bottom: 15px;
                `;
                img.parentNode.insertBefore(caption, img.nextSibling);
            }
        });
        
        // Ê∑ªÂä†ÊâìÂç∞Ê†∑Âºè
        const printStyle = document.createElement('style');
        printStyle.id = 'juejin-print-style';
        printStyle.textContent = `
            @media print {
                body {
                    margin: 0;
                    padding: 0;
                    font-size: 12pt;
                }
                
                .article-title {
                    font-size: 18pt;
                    margin-bottom: 10px;
                    page-break-after: avoid;
                }
                
                .article-content {
                    font-size: 12pt;
                    line-height: 1.5;
                }
                
                h1, h2, h3, h4, h5, h6 {
                    page-break-after: avoid;
                    page-break-inside: avoid;
                }
                
                pre, code, table {
                    page-break-inside: avoid;
                }
                
                img {
                    page-break-inside: avoid;
                    max-width: 100% !important;
                }
                
                a {
                    text-decoration: underline;
                    color: #000;
                }
                
                #juejin-print-panel {
                    display: none !important;
                }
                
                /* Á°Æ‰øù‰ª£Á†ÅÂùóÂú®ÊâìÂç∞Êó∂ÊúâËÉåÊôØËâ≤ */
                pre {
                    background-color: #f6f8fa !important;
                    border: 1px solid #ddd !important;
                    padding: 10px !important;
                    -webkit-print-color-adjust: exact !important;
                    color-adjust: exact !important;
                    print-color-adjust: exact !important;
                }
                
                /* Ê∑ªÂä†È°µÁ†Å */
                @page {
                    margin: 1cm;
                    @bottom-center {
                        content: "Á¨¨ " counter(page) " È°µÔºåÂÖ± " counter(pages) " È°µ";
                    }
                }
            }
        `;
        document.head.appendChild(printStyle);
        
        // Á°Æ‰øùÊéßÂà∂Èù¢ÊùøÊ†∑Âºè‰∏çÂèóÈ°µÈù¢‰ºòÂåñÂΩ±Âìç
        const panel = document.getElementById('juejin-print-panel');
        if (panel) {
            panel.style.width = '150px';
            panel.style.boxSizing = 'content-box';
            panel.style.fontSize = '14px';
            
            // ÈáçÁΩÆÊåâÈíÆÊ†∑Âºè
            const buttons = panel.querySelectorAll('button');
            buttons.forEach(button => {
                button.style.width = 'calc(100% - 10px)';
                button.style.boxSizing = 'border-box';
                button.style.margin = '5px';
                button.style.padding = '5px 10px';
            });
            
            // ÈáçÊñ∞ÁªëÂÆöÊãñÊãΩ‰∫ã‰ª∂
            makeDraggable(panel);
        }
        
        // Â§ÑÁêÜÊâìÂç∞Êàñ‰øùÂ≠òPDF
        if (autoPrint || savePdf) {
            // ‰∏¥Êó∂ÈöêËóèÊéßÂà∂Èù¢Êùø
            panel.style.display = 'none';
            
            // Âª∂ËøüË∞ÉÁî®ÊâìÂç∞ÂäüËÉΩÔºåÁ°Æ‰øùÊ†∑ÂºèÂ∑≤Â∫îÁî®
            setTimeout(function() {
                if (savePdf) {
                    // ‰ΩøÁî®ÊµèËßàÂô®ÁöÑÊâìÂç∞ÂäüËÉΩÔºåÈÄâÊã©"Âè¶Â≠ò‰∏∫PDF"
                    const printOptions = {
                        filename: `${articleTitle.replace(/[\\/:*?"<>|]/g, '_')}.pdf`,
                    };
                    window.print();
                    // Ê≥®ÊÑèÔºöÁî±‰∫éÊµèËßàÂô®ÂÆâÂÖ®ÈôêÂà∂ÔºåÊó†Ê≥ïËá™Âä®ÈÄâÊã©"Âè¶Â≠ò‰∏∫PDF"ÈÄâÈ°πÔºå
                    // Áî®Êà∑ÈúÄË¶ÅÂú®ÊâìÂç∞ÂØπËØùÊ°Ü‰∏≠ÊâãÂä®ÈÄâÊã©"Âè¶Â≠ò‰∏∫PDF"
                } else if (autoPrint) {
                    window.print();
                }
                
                // ÊâìÂç∞ÂÆåÊàêÂêéÊòæÁ§∫ÊéßÂà∂Èù¢Êùø
                setTimeout(function() {
                    panel.style.display = 'block';
                }, 1000);
            }, 500);
        }
    }
    
    // Á≠âÂæÖÈ°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂàõÂª∫ÊéßÂà∂Èù¢Êùø
    setTimeout(function() {
        createControlPanel();
    }, 1500);
})(); 